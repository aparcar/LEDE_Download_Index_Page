# OpenWrt Directory Listing CGI

This repository contains a CGI script that improves over the default Apache/nginx directory listing. It displays:

* An attractive, shortened file name (instead of the full path that contains lots of redundant information)
* The checksum for easy verification before flashing
* The file size and modification date
* Using OpenWrt styling

The repo has several kinds of files:

1. **OpenWrt "targets" listing** for devices having the same target.
This shows the image files plus supplementary files - build tools,
the imagebuilder, sha256sum, signature file, and other useful files. 
2. **Normal directory listings** with file name, size, and modification date.
3. **404 Page not found** page that displays the URL 
4. **JSON of the directory contents**
5. **New home page** A new page to replace [downloads.openwrt.org](https://downloads.openwrt.org) .
6. **Archive page** that lists older, unmaintained versions of OpenWrt

## Configuration

* The `dir-index.cgi` file in this repository is a CGI script that formats a directory's contents to produce these listings. It relies on two environment variables:
  * DOCUMENT_ROOT - the directory containing files to be formatted. This becomes the `$phys` variable within the CGI
  * PATH_INFO - the path that encodes the target/sub-target. This becomes the `$virt` variable
* The `/static/` directory must be at the root of the server and contain:
  * `style.css` that contains the CSS for these pages
  * `logo.png` a PNG image for the OpenWrt logo
* The `nginx-snippet.conf` file is used to configure nginx on the main OpenWrt server to use the `dir-index.cgi` file to format the directory pages.

## Testing

The `test.sh` script creates an output file for each of the file types above.
Click the links below to view the pages in a browser.

* [targets.html](http://localhost:8123/targets.html) - the "target firmware" page
* [directory.html](http://localhost:8123/directory.html) - a "normal" directory page
* [404.html](http://localhost:8123/404.html) - the Page Not Found page
* [output.json](http://localhost:8123/output.json) - the JSON output of the script

These files are static, and not generated by `dir-index.cgi`.

* [index.html](http://localhost:8123/index.html) - new home page for the downloads.openwrt.org.
* [archive.html](http://localhost:8123/archive.html) - separate page listing historic, no-longer-maintained versions.

**Developing and Testing**

`test.sh` is a script that regenerates the Targets, Directory, 404 and JSON files.
To test development builds, open two terminal windows, then:

1. First window re-runs the `test.sh` script to generate pages:

  ```
  cd openwrt-download-page
  sh test.sh
  ```
2. Run an HTTP server on port 8123 in the second window:

    ```
    cd openwrt-download-page
    python3 -m http.server 8123
    ```
3. Update a source file, re-run `test.sh` and reload the browser using the links in the **Testing** section above

**Verifying HTML Output**

Paste the HTML files into [W3C Markup Validation Service](https://validator.w3.org/#validate_by_input) to verify that the HTML output is good.

## Provenance of Assorted Assets

* SVG images of OpenWrt logo (three color variations) from [https://gist.github.com/jow-/503002651aa3ee3e8803b5ad29abf7ca#file-openwrt-logo-white-and-dark-blue-svg](https://gist.github.com/jow-/503002651aa3ee3e8803b5ad29abf7ca#file-openwrt-logo-white-and-dark-blue-svg)
* GalanoGrotesque.woff comes from OpenWrt repo: [https://github.com/openwrt/luci/blob/master/themes/luci-theme-openwrt-2020/htdocs/luci-static/openwrt2020/GalanoGrotesqueW00-Regular.woff2
](https://github.com/openwrt/luci/blob/master/themes/luci-theme-openwrt-2020/htdocs/luci-static/openwrt2020/GalanoGrotesqueW00-Regular.woff2
)
* Canonical CSS file for OpenWrt theme: [https://github.com/openwrt/luci/blob/master/themes/luci-theme-openwrt-2020/htdocs/luci-static/openwrt2020/cascade.css](https://github.com/openwrt/luci/blob/master/themes/luci-theme-openwrt-2020/htdocs/luci-static/openwrt2020/cascade.css)
* Logo used in header is now a PNG to avoid concerns of XSS. This would not be a threat as long as we trust whoever is uploading images (particularly SVGs) not to incorporate hidden Javascript. However, a PNG is safer.
* Current OpenWrt Logo Guidelines are archived in this repo. Original found at: [http://ynezz.true.cz/openwrt/logo/OpenWrt\_Logo\_Usage\_Guidelines-final.pdf](http://ynezz.true.cz/openwrt/logo/OpenWrt_Logo_Usage_Guidelines-final.pdf) as described in OpenWrt forum posting at [https://forum.openwrt.org/t/please-fix-kerning-in-new-logo/72874/23](https://forum.openwrt.org/t/please-fix-kerning-in-new-logo/72874/23) 
